# Прогнозирование продаж

## Постановка задачи
**Задача:** Прогнозирование недельных продаж для розничной сети  
**Целевая переменная:** `Weekly_Sales` - продажи за неделю (в долларах)

### Признаки (features)

| Категория | Признаки | Описание | Тип |
|-----------|----------|----------|-----|
| **Базовые** | `Store` | ID магазина (1-45) | Категориальный |
| | `Type` | Тип магазина (A/B/C) | Категориальный |
| | `Size` | Размер магазина | Числовой |
| **Временные** | `Date` | Дата (пятница) | Дата |
| | `IsHoliday` | Праздничная неделя | Бинарный |
| **Департамент** | `Dept` | Номер департамента | Категориальный |
| **Экономика** | `Temperature` | Температура | Числовой |
| | `Fuel_Price` | Цена топлива | Числовой |
| | `CPI` | Индекс цен | Числовой |
| | `Unemployment` | Безработица | Числовой |
| **Маркетинг** | `MarkDown1-5` | Данные промо-акций | Числовой |

---

## EDA (Exploratory Data Analysis)

### Общая информация
- **Объем данных:** 421,570 записей
- **Период:** 2010-2012 годы (3 года)
- **Частота:** Еженедельные данные (пятницы)
- **Уникальных:** 45 магазинов, 81 департамент

### Ключевые инсайты

#### **1. Распределение целевой переменной**
| Метрика | Значение | Интерпретация |
|---------|----------|---------------|
| Среднее продажи | $15,981 | Базовая линия |
| Стандартное отклонение | $22,711 | Высокая вариативность |
| Асимметрия | 3.26 | Сильное правостороннее смещение |
| Выбросы | 8.43% (35,521 зап.) | Требуют обработки |
| Отрицательные продажи | Присутствуют | Ошибки данных |

#### **2. Временные паттерны**
- **Тренд:** Восходящий (рост продаж за период)
- **Сезонность:** Ярко выражена (пики в ноябре-декабре)
- **Праздники:** Значительное влияние (+15-25% продаж)
- **Частота:** Все записи - пятницы (конец отчетной недели)

#### **3. Корреляционный анализ**
**Топ-3 корреляции с продажами:**
1. **Size** (размер магазина): 0.24 
2. **Type** (тип магазина): 0.18   
3. **Dept** (департамент): 0.15 

**Экономические показатели:** Корреляция < 0.03 (очень слабая)  
**Мультиколлинеарность:** Отсутствует (нет пар с корреляцией > 0.7)

#### **4. Выбросы и аномалии**
- **Процент выбросов:** 8.43% (выше стандартного 5%)
- **Распределение:** Неравномерное по магазинам
- **Причины:** Праздничные распродажи, акции, ошибки данных

#### **5. Категориальные признаки**
| Признак | Уникальных | Тип | Особенности |
|---------|------------|-----|-------------|
| `Store` | 45 | Высококардинальный | Географическое распределение |
| `Dept` | 81 | Высококардинальный | Товарные категории |
| `Type` | 3 | Низкокардинальный | A > B > C по продажам |
| `IsHoliday` | 2 | Бинарный | Сезонное влияние |

---

## Необходимые преобразования

### Высокий приоритет
1. **Обработка выбросов:** Логарифмирование или winsorization
2. **Кодирование категорий:** Target Encoding для Store и Dept
3. **Временные фичи:** Лаги + скользящие статистики

### Средний приоритет
4. **Признаки взаимодействия:** Size×Type, Holiday×Month
5. **Сезонность:** Кварталы, времена года
6. **Экономические:** Взаимодействия CPI×Unemployment

---

## Baseline Модели

### Тестированные модели (TimeSeriesSplit, gap=1)

#### Линейные модели *(низкая производительность)*
| Модель | MAE | RMSE | R² | Вывод |
|--------|-----|------|----|-------|
| LinearRegression | $14,321.98 ± $685.85 | $21,281.33 ± $1,973.93 | 0.1313 ± 0.1046 | Слишком прост для данных |
| Ridge Regression | $14,321.69 ± $685.31 | $21,281.03 ± $1,973.36 | 0.1313 ± 0.1045 | Регуляризация не помогла |
| Lasso Regression | $14,321.19 ± $684.78 | $21,280.58 ± $1,972.83 | 0.1313 ± 0.1045 | Отбор признаков не решил проблему |

#### Tree-based модели *(значительно лучше)*
| Модель | MAE | RMSE | R² | Улучшение vs Linear |
|--------|-----|------|----|-------------------|
| **XGBoost**  | **$11,130.90 ± $251.22** | **$18,039.08 ± $1,024.09** | **0.3762 ± 0.0286** | **2.9× лучше по R²** |
| RandomForest | $10,999.60 ± $337.00 | $18,210.86 ± $903.46 | 0.3625 ± 0.0504 | 2.8× лучше |
| GradientBoosting | $12,900.29 ± $248.63 | $19,582.43 ± $1,033.13 | 0.2651 ± 0.0198 | 2.0× лучше |

### Важность признаков (RandomForest - Top 10)

| Место | Признак | Важность | Категория |
|-------|---------|----------|-----------|
| 1 | Size (размер магазина) | 0.24 | Базовые |
| 2 | Type (тип магазина) | 0.18 | Базовые |
| 3 | Dept (департамент) | 0.15 | Департамент |
| 4 | MarkDown5 | 0.05 | Маркетинг |
| 5 | MarkDown1 | 0.04 | Маркетинг |
| 6 | MarkDown3 | 0.04 | Маркетинг |
| 7 | MarkDown4 | 0.04 | Маркетинг |
| 8 | MarkDown2 | 0.02 | Маркетинг |
| 9 | IsHoliday | 0.01 | Временные |
| 10 | CPI | -0.02 | Экономика |

### Анализ важности
- **Size, Type, Dept** - наиболее важные признаки
- **MarkDown переменные** - умеренная важность
- **Экономические показатели** - низкая важность
- **Временные признаки** - важны для прогнозирования

---

## Метрики качества

### Абсолютные метрики (лучшая модель baseline - XGBoost)
- **MAE:** $11,131
- **RMSE:** $18,039
- **R²:** 0.376

### Относительные метрики
- **MAE/Mean Sales:** 69.6% *(высокая ошибка)*
- **Точность прогноза:** 30.4% *(недостаточно для бизнеса)*
- **Бизнес-оценка:** **НИЗКАЯ**

---

## Эксперименты по улучшению модели

### Эксперимент 1: Временные признаки (TimeSeriesSplit оценка)
| Эксперимент | RMSE | Улучшение от baseline | R² |
|-------------|------|----------------------|----|
| Baseline | 13,264.4 | - | 0.626 |
| + month | 13,216.0 | +0.36% | 0.629 |
| + week_of_year | 13,214.1 | +0.38% | 0.630 |
| + quarter | 13,287.9 | -0.18% | 0.625 |
| + все временные | **13,203.4** | **+0.46%** | **0.630** |

**Вывод**: Все временные признаки дали максимальное улучшение (+0.46%)

### Эксперимент 2: Трансформации целевой переменной (TimeSeriesSplit оценка)
| Трансформация | RMSE | Улучшение | R² |
|---------------|------|-----------|----|
| Без трансформации | 13,142.0 | - | 0.633 |
| Квадратный корень | 12,899.1 | +1.85% | 0.646 |
| **Логарифмирование** | **12,584.7** | **+4.24%** | **0.663** |

**Вывод**: Логарифмирование целевой переменной дало наибольшее улучшение (+4.24%)

### Эксперимент 3: Lag features
| Конфигурация лагов | RMSE | Улучшение | R² |
|-------------------|------|-----------|----|
| **Baseline (без лагов)** | **12,476.5** | **-** | **0.668** |
| Короткие лаги (1-4) | 13,025.9 | -4.40% | 0.614 |
| Сезонные лаги (1,4,13,52) | 13,188.4 | -5.71% | 0.610 |
| Все лаги (1-4,13,52) | 13,354.7 | -7.04% | 0.599 |
| Только lag=1 | 12,731.1 | -2.04% | 0.650 |
| Только lag=52 (год) | 13,976.5 | -12.02% | 0.569 |

**Анализ влияния отдельных лагов:**
| Лаг | Средний RMSE | Минимальный RMSE | Максимальный RMSE |
|-----|--------------|------------------|------------------|
| 1 | 13,199.1 | 12,731.1 | 13,695.2 |
| 13 | 13,271.5 | 13,188.4 | 13,354.7 |
| 52 | 13,506.5 | 13,188.4 | 13,976.5 |

**Вывод**: Lag features **ухудшили** качество модели на 2-12%, лучший результат достигнут без лагов

---

## Эксперимент 4: ГИПЕРПАРАМЕТРИЧЕСКИЙ ТЮНИНГ (Логарифмирование + XGBoost)

### Загрузка и подготовка данных
- **Данные:** 25 признаков, 421,570 записей
- **Типы признаков:** Числовых: 11, Категориальных: 14
- **Трансформация:** Логарифмирование целевой переменной

### Сравнение базовых моделей (2 фолда)
| Модель | RMSE | R² |
|--------|------|----|
| RandomForest Baseline | 16,971.2 | 0.216 |
| **LightGBM Baseline** | **13,681.1** | **0.514** |
| XGBoost Baseline | 15,803.0 | 0.326 |

**Вывод:** LightGBM показал лучшие результаты на baseline

### Тюнинг лучших моделей
Тюнинг проводился для двух лучших моделей: **LightGBM** и **XGBoost**

#### LightGBM Random Search (10 итераций)
- **Лучшие параметры:** 
  - `n_estimators`: 200
  - `learning_rate`: 0.01
  - `num_leaves`: 100
  - `max_depth`: -1
  - `subsample`: 0.8
- **Лучший RMSE:** 12,822.9

#### XGBoost Random Search (10 итераций)
- **Лучшие параметры:**
  - `n_estimators`: 150
  - `learning_rate`: 0.05
  - `max_depth`: 5
  - `subsample`: 0.9
  - `colsample_bytree`: 0.8
- **Лучший RMSE:** 13,255.5

### Финальная оценка на полных данных (3 фолда TimeSeriesSplit)

#### RandomForest моделей:
| Модель | RMSE | R² | Вывод |
|--------|------|----|-------|
| RandomForest (старый exp) | 14,897.5 | 0.490 | Низкая точность |
| RandomForest (новый exp) | 15,319.3 | 0.477 | Худший результат |

#### LightGBM моделей:
| Модель | RMSE | R² | Улучшение |
|--------|------|----|-----------|
| LightGBM Baseline | 12,908.9 | 0.612 | Baseline |
| LightGBM Tuned | 12,824.1 | 0.626 | +0.66% |

#### XGBoost моделей:
| Модель | RMSE | R² | Улучшение |
|--------|------|----|-----------|
| XGBoost Baseline | 13,263.1 | 0.591 | Baseline |
| XGBoost Tuned | 12,498.8 | 0.657 | **+5.76%** |

### Итоговое сравнение всех моделей

| Модель | RMSE | RMSE_std | MAE | MAE_std | R² | R²_std | Тип | Улучшение RMSE (%) |
|--------|------|----------|-----|---------|----|--------|-----|-------------------|
| RandomForest Baseline | 14,897.5 | 527.7 | 8,319.0 | 295.4 | 0.490 | 0.168 | Baseline | - |
| LightGBM Baseline | 12,622.3 | 699.7 | 7,219.4 | 746.6 | 0.633 | 0.115 | Baseline | - |
| XGBoost Baseline | 13,263.1 | 997.9 | 7,543.2 | 876.8 | 0.591 | 0.140 | Baseline | - |
| LightGBM Tuned | 13,028.1 | 1,363.7 | 7,256.3 | 498.1 | 0.626 | 0.077 | Tuned | -3.21 |
| **XGBoost Tuned** | **12,498.8** | **849.0** | **7,164.4** | **117.5** | **0.657** | **0.052** | **Tuned** | **+5.76** |

---

## Ключевые выводы по всем экспериментам

### 1. Эффективность feature engineering
- **Временные признаки:** +0.46% улучшения (незначительно)
- **Логарифмирование цели:** +4.24% улучшения (значимо)
- **Lag features:** -2% до -12% ухудшения (не эффективны)

### 2. Сравнение алгоритмов
1. **XGBoost Tuned** - лучший результат: RMSE 12,498.8
2. **LightGBM Baseline** - хороший baseline: RMSE 12,622.3  
3. **LightGBM Tuned** - ухудшение на 3.21%
4. **RandomForest** - худшие результаты среди tree-based моделей

### 3. Влияние тюнинга гиперпараметров
- **XGBoost:** +5.76% улучшение после тюнинга
- **LightGBM:** -3.21% ухудшение после тюнинга
